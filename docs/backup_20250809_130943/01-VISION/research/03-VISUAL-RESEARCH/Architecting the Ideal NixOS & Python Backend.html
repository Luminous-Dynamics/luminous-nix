<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NixOS & Python: The Idiomatic Integration Blueprint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .flowchart-node {
            border: 2px solid #0077D8;
            background-color: #EBF8FF;
            color: #00449E;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .flowchart-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #0077D8;
            margin: 0.5rem 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #005CB9, #0077D8);
            color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
        }
        .stat-number {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
        }
        .stat-label {
            font-size: 1.125rem;
            font-weight: 600;
            opacity: 0.9;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#00449E] mb-2">Architecting the Ideal NixOS & Python Backend</h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto">Moving beyond subprocess calls to build a robust, performant, and truly "Nix-idiomatic" integration.</p>
        </header>

        <main class="space-y-12">

            <section id="challenge">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div class="card">
                        <h2 class="text-2xl font-bold text-[#005CB9] mb-4">The Subprocess Trap</h2>
                        <p class="mb-4">The simplest way to call Nix from Python‚Äîusing a `subprocess`‚Äîis also the most flawed. Each call is a new process, incurring significant startup overhead that makes it unsuitable for high-performance applications.</p>
                        <p>This method treats Nix as a black box, returning unstructured text that is difficult to parse and offers no granular error handling. It's time for a more native approach.</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">100-500ms</div>
                        <div class="stat-label">Startup Overhead Per Call</div>
                    </div>
                </div>
            </section>

            <section id="comparison" class="card col-span-1 md:col-span-2">
                <h2 class="text-2xl font-bold text-[#005CB9] mb-2 text-center">A Performance Showdown: Nix-Python Communication Methods</h2>
                <p class="text-center text-gray-600 mb-6">Choosing the right communication strategy is critical. This comparison reveals a clear winner for applications demanding speed and reliability.</p>
                <div class="chart-container">
                    <canvas id="ipcComparisonChart"></canvas>
                </div>
                <div class="mt-6 text-center text-gray-700">
                    <p><strong class="text-[#005CB9]">Direct Socket IPC</strong> is the most performant and idiomatic method, as it's the native channel used by Nix tools. While complex to implement, it offers the lowest latency and highest throughput, making it ideal for rapid, frequent queries.</p>
                </div>
            </section>

            <section id="safety">
                <h2 class="text-2xl font-bold text-[#005CB9] mb-6 text-center">The "Don't Break the Build" Mandate: Safe File Editing</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card border-2 border-red-400 bg-red-50">
                        <h3 class="text-xl font-bold text-red-700 mb-3 flex items-center"><span class="text-2xl mr-2">‚ùå</span>The Wrong Way: Text Manipulation</h3>
                        <p class="mb-4 text-red-600">Using string replacement or regex is dangerous. This approach is blind to Nix syntax and can easily introduce errors, break user formatting, and corrupt configuration files.</p>
                        <pre class="bg-red-100 p-2 rounded text-sm text-red-800"><code># Fragile and error-prone
config_text.replace(
  "packages = [",
  "packages = [ pkgs.htop"
)</code></pre>
                    </div>
                    <div class="card border-2 border-green-400 bg-green-50">
                        <h3 class="text-xl font-bold text-green-700 mb-3 flex items-center"><span class="text-2xl mr-2">‚úÖ</span>The Right Way: AST Manipulation</h3>
                        <p class="mb-4 text-green-600">The only safe method is to parse the code into an Abstract Syntax Tree (AST), modify the tree, and then print it back. This guarantees syntactic validity.</p>
                        <pre class="bg-green-100 p-2 rounded text-sm text-green-800"><code># Safe and syntactically aware
nix_file = rnix.parse_file(...)
node = nix_file.find_node(...)
node.append_element(...)</code></pre>
                    </div>
                </div>
                 <p class="mt-6 text-center text-gray-700">By treating code as structured data with a lossless parser like <code class="bg-gray-200 px-1 rounded">rnix-parser</code>, we can make surgical changes while preserving user comments and formatting, ensuring a non-disruptive experience.</p>
            </section>

            <section id="architecture" class="card col-span-1 md:col-span-2">
                <h2 class="text-2xl font-bold text-[#005CB9] mb-6 text-center">Blueprint for a "Nix-Idiomatic" Backend</h2>
                <p class="text-center text-gray-600 mb-8">A robust architecture separates concerns into three distinct layers, ensuring a maintainable and scalable system.</p>
                <div class="w-full max-w-2xl mx-auto">
                    <div class="flowchart-node">
                        <h4 class="text-lg">Presentation / API Layer (Python)</h4>
                        <p class="font-normal text-sm">Exposes high-level, declarative actions to the user (e.g., `add_package(...)`)</p>
                    </div>
                    <div class="flowchart-arrow">‚¨áÔ∏è</div>
                    <div class="flowchart-node">
                        <h4 class="text-lg">Configuration & Language Layer (Python + rnix-parser)</h4>
                        <p class="font-normal text-sm">Reads, transforms (via AST), and atomically writes `.nix` files.</p>
                    </div>
                    <div class="flowchart-arrow">‚¨áÔ∏è</div>
                    <div class="flowchart-node">
                        <h4 class="text-lg">Evaluation & Store Layer (Python + IPC Client/FFI)</h4>
                        <p class="font-normal text-sm">Communicates with the Nix daemon and engine for evaluation and store operations.</p>
                    </div>
                </div>
            </section>

            <section id="principles">
                 <h2 class="text-2xl font-bold text-[#005CB9] mb-6 text-center">Core Principles for Success</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="card text-center">
                        <div class="text-4xl mb-3">üìú</div>
                        <h3 class="font-bold text-lg text-[#005CB9]">Embrace Declarative APIs</h3>
                        <p class="text-sm">Design functions that describe an end state, not a sequence of steps. This mirrors the core philosophy of Nix.</p>
                    </div>
                    <div class="card text-center">
                        <div class="text-4xl mb-3">üå≥</div>
                        <h3 class="font-bold text-lg text-[#005CB9]">Treat Nix Code as Data</h3>
                        <p class="text-sm">Never use string manipulation. Always use an AST/CST parser for modifying `.nix` files to guarantee safety.</p>
                    </div>
                     <div class="card text-center">
                        <div class="text-4xl mb-3">‚ö°Ô∏è</div>
                        <h3 class="font-bold text-lg text-[#005CB9]">Use the Right Channel</h3>
                        <p class="text-sm">Use direct socket IPC for frequent queries and FFI for complex evaluations. Avoid subprocess calls.</p>
                    </div>
                 </div>
            </section>

        </main>

        <footer class="text-center mt-12 pt-8 border-t border-gray-200">
            <p class="text-sm text-gray-500">&copy; 2025 NixOS Integration Insights. Infographic generated based on internal research.</p>
        </footer>

    </div>

    <script>
        function wrapLabel(str, maxWidth) {
            if (str.length <= maxWidth) {
                return str;
            }
            const words = str.split(' ');
            let lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + word).length > maxWidth) {
                    lines.push(currentLine.trim());
                    currentLine = '';
                }
                currentLine += word + ' ';
            }
            lines.push(currentLine.trim());
            return lines.filter(line => line.length > 0);
        }

        const ipcData = {
            labels: ['Subprocess `nix eval`', 'FFI (`tweag/python-nix`)', 'Direct Socket IPC'],
            datasets: [
                {
                    label: 'Performance / Throughput',
                    data: [2, 8, 10],
                    backgroundColor: '#0077D8',
                    borderColor: '#005CB9',
                    borderWidth: 1
                },
                {
                    label: 'Implementation Simplicity',
                    data: [9, 5, 2],
                    backgroundColor: '#89C4EB',
                    borderColor: '#4199E1',
                    borderWidth: 1
                },
                {
                    label: 'Nix-Idiomatic Score',
                    data: [2, 4, 5],
                    backgroundColor: '#4199E1',
                    borderColor: '#005CB9',
                    borderWidth: 1
                },
            ]
        };

        const ctx = document.getElementById('ipcComparisonChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ipcData.labels.map(label => wrapLabel(label, 16)),
                datasets: ipcData.datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 10,
                        title: {
                            display: true,
                            text: 'Relative Score (1 = Low, 10 = High)',
                            font: {
                                weight: '600'
                            }
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: 12,
                                weight: '600'
                            },
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const item = tooltipItems[0];
                                let label = item.chart.data.labels[item.dataIndex];
                                if (Array.isArray(label)) {
                                  return label.join(' ');
                                } else {
                                  return label;
                                }
                            }
                        }
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    </script>
</body>
</html>
