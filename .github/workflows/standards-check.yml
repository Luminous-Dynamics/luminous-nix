name: ðŸ“‹ Standards Compliance Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # 1. Python Code Quality
  python-quality:
    name: ðŸ Python Standards
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: ðŸ“š Load cached dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: ðŸ“¦ Install dependencies
        run: |
          poetry install --all-extras
          poetry run pip install pre-commit

      - name: ðŸŽ¨ Check Black formatting (88 chars)
        run: |
          echo "Checking Black formatting with 88-character line length..."
          poetry run black --check --line-length 88 src/ tests/ scripts/
        continue-on-error: true

      - name: ðŸ” Run Ruff linting
        run: |
          echo "Running Ruff with comprehensive rule set..."
          poetry run ruff check src/ tests/ scripts/
        continue-on-error: true

      - name: ðŸ”Ž Check type hints with mypy
        run: |
          echo "Checking type hints with mypy strict mode..."
          poetry run mypy src/ --strict
        continue-on-error: true

      - name: ðŸ”’ Security scan with Bandit
        run: |
          echo "Scanning for security issues..."
          poetry run bandit -r src/ -ll
        continue-on-error: true

      - name: ðŸ“Š Generate quality report
        if: always()
        run: |
          echo "## ðŸ Python Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check Black
          if poetry run black --check --line-length 88 src/ tests/ scripts/ 2>/dev/null; then
            echo "âœ… **Black formatting**: Passed (88 chars)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Black formatting**: Failed - Run \`poetry run black .\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check Ruff
          if poetry run ruff check src/ tests/ scripts/ 2>/dev/null; then
            echo "âœ… **Ruff linting**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Ruff linting**: Issues found - Run \`poetry run ruff check --fix .\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check mypy
          if poetry run mypy src/ --strict 2>/dev/null; then
            echo "âœ… **Type checking**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Type checking**: Issues found" >> $GITHUB_STEP_SUMMARY
          fi

  # 2. Pre-commit Hooks
  pre-commit:
    name: ðŸ”§ Pre-commit Checks
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ”§ Run pre-commit hooks
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: --all-files

  # 3. Documentation Standards
  documentation:
    name: ðŸ“š Documentation Standards
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“‹ Check documentation standards
        run: |
          python3 scripts/compliance-check.py
          
      - name: ðŸ“Š Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: docs/COMPLIANCE_REPORT.json

      - name: ðŸ” Check for required docs
        run: |
          echo "## ðŸ“š Documentation Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          required_docs=(
            "README.md"
            "CHANGELOG.md"
            "LICENSE"
            "docs/README.md"
            "docs/PYTHON-PACKAGING-STANDARDS.md"
            "docs/API-VERSIONING-STANDARDS.md"
            "docs/PERFORMANCE-STANDARDS.md"
          )
          
          all_present=true
          for doc in "${required_docs[@]}"; do
            if [ -f "$doc" ]; then
              echo "âœ… $doc" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $doc (missing)" >> $GITHUB_STEP_SUMMARY
              all_present=false
            fi
          done
          
          if [ "$all_present" = false ]; then
            exit 1
          fi

  # 4. Commit Message Standards
  commit-lint:
    name: ðŸ“ Commit Standards
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Check commit messages
        run: |
          echo "## ðŸ“ Commit Message Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get commits in this PR
          commits=$(git log --format="%s" origin/main..HEAD)
          
          valid_types="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"
          invalid_count=0
          
          while IFS= read -r commit; do
            if [[ $commit =~ ^($valid_types)(\(.+\))?: ]]; then
              echo "âœ… $commit" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ $commit (invalid format)" >> $GITHUB_STEP_SUMMARY
              invalid_count=$((invalid_count + 1))
            fi
          done <<< "$commits"
          
          if [ $invalid_count -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **$invalid_count invalid commit messages found**" >> $GITHUB_STEP_SUMMARY
            echo "Expected format: \`type(scope): subject\`" >> $GITHUB_STEP_SUMMARY
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert" >> $GITHUB_STEP_SUMMARY
          fi

  # 5. Test Coverage
  test-coverage:
    name: ðŸ§ª Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Poetry
        uses: snok/install-poetry@v1

      - name: ðŸ“¦ Install dependencies
        run: poetry install --all-extras

      - name: ðŸ§ª Run tests with coverage
        run: |
          poetry run pytest --cov=nix_for_humanity --cov-report=xml --cov-report=term
        continue-on-error: true

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: ðŸ“ˆ Coverage report
        run: |
          echo "## ðŸ§ª Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          poetry run pytest --cov=nix_for_humanity --cov-report=term | tail -n 10 >> $GITHUB_STEP_SUMMARY || echo "Tests not available" >> $GITHUB_STEP_SUMMARY

  # 6. Final Status Report
  status-report:
    name: ðŸ“Š Status Report
    needs: [python-quality, pre-commit, documentation, commit-lint, test-coverage]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š Generate final report
        run: |
          echo "# ðŸŽ¯ Standards Compliance Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          # Check job statuses
          if [ "${{ needs.python-quality.result }}" == "success" ]; then
            echo "| Python Standards | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Python Standards | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.pre-commit.result }}" == "success" ]; then
            echo "| Pre-commit Hooks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Pre-commit Hooks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.documentation.result }}" == "success" ]; then
            echo "| Documentation | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Documentation | âŒ Incomplete |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.commit-lint.result }}" == "success" ] || [ "${{ needs.commit-lint.result }}" == "skipped" ]; then
            echo "| Commit Messages | âœ… Valid |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Commit Messages | âš ï¸ Issues |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-coverage.result }}" == "success" ]; then
            echo "| Test Coverage | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Test Coverage | âš ï¸ Check |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Standards enforced by Sacred Trinity development model* ðŸ•‰ï¸" >> $GITHUB_STEP_SUMMARY