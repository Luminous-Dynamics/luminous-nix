name: Update Nix Flake Inputs

on:
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday at midnight UTC

jobs:
  update-flake:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use a personal access token if you want the PR to trigger other workflows
          # token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for better git operations

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12
        with:
          logger: pretty
          diagnostic-endpoint: ""

      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Update flake.lock
        uses: DeterminateSystems/update-flake-lock@main
        with:
          pr-title: "‚¨ÜÔ∏è Update Nix flake inputs"
          pr-body: |
            ## ü§ñ Automated Dependency Update

            This PR updates the `flake.lock` file with the latest versions of all inputs.

            ### Pre-merge Checklist
            - [ ] All CI checks pass
            - [ ] `nix flake check` succeeds
            - [ ] Basic functionality tested locally
            - [ ] No breaking changes identified

            ### What's Updated
            See the diff below for specific version changes.

            ---
            *Generated by Sacred Trinity automation üåä*
          pr-labels: |
            dependencies
            automated
            flake-update
          branch: "flake-update"
          commit-msg: "chore(deps): update flake.lock"

  # Run checks on the PR
  validate-update:
    needs: update-flake
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12

      - name: Check flake health
        uses: DeterminateSystems/flake-checker-action@main
        with:
          flake-lock-path: ./flake.lock

      - name: Run flake checks
        run: |
          echo "üîç Running comprehensive flake validation..."
          nix flake check --all-systems
          nix flake show

      - name: Test basic build
        run: |
          echo "üèóÔ∏è Testing basic build..."
          nix build .#ask-nix-guru --no-link

      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ All flake validation checks passed! Safe to merge.'
            })
